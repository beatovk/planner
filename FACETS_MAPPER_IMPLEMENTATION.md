# Facets Mapper Implementation

## –û–±–∑–æ—Ä

–£—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä—ë–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞–ø–ø–µ—Ä —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–ª–∞–≥–∏ –¥–ª—è Week Planner. –ù–æ–≤—ã–π –º–∞–ø–ø–µ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–±—ã—Ç–∏–π (title, description, tags) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ù–æ–≤—ã–π –º–∞–ø–ø–µ—Ä `map_event_to_flags`

**–§–∞–π–ª**: `core/query/facets.py`

```python
def map_event_to_flags(event: dict) -> list[str]:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π ‚Üí —Ñ–ª–∞–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    
    Args:
        event: –°–ª–æ–≤–∞—Ä—å —Å–æ–±—ã—Ç–∏—è —Å –ø–æ–ª—è–º–∏ title, description, tags
        
    Returns:
        –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–ª–∞–≥–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏—è
    """
```

### 2. –ü—Ä–∞–≤–∏–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏

```python
CATEGORY_RULES = {
    "electronic_music": ["electronic", "dj", "club"],
    "live_music": ["live music", "gig", "band"],
    "jazz_blues": ["jazz", "blues"],
    "rooftop": ["rooftop", "view", "skybar", "bar"],
    "food_dining": ["food", "thai food", "street food", "dining", "restaurant"],
    "art_exhibits": ["art", "exhibition", "gallery", "museum"],
    "workshops": ["workshop", "learning", "craft", "class", "course"],
    "cinema": ["cinema", "movie", "film", "screening"],
    "markets": ["market", "mall", "shopping", "bazaar", "fair"],
    "yoga_wellness": ["yoga", "meditation", "wellness", "retreat"],
    "parks": ["park", "walk", "nature", "outdoor", "garden"],
}
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π

**–§–∞–π–ª**: `scripts/diag_verify.py`

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π –º–∞–ø–ø–µ—Ä
- Fallback –Ω–∞ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –µ—Å–ª–∏ –º–∞–ø–ø–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ —Ñ–ª–∞–≥–∞–º–∏ –≤ –æ—Ç—á—ë—Ç–µ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª**: `tests/unit/test_facets_mapper.py`

```bash
python3 -m pytest -q tests/unit/test_facets_mapper.py -v
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ 12 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–¢–µ—Å—Ç –º–∞–ø–ø–∏–Ω–≥–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**:

```python
# Sample Art Exhibition 1 ‚Üí ['art_exhibits'] ‚úÖ
# Jazz Night at Skybar ‚Üí ['jazz_blues', 'rooftop'] ‚úÖ  
# Thai Street Food Festival ‚Üí ['food_dining'] ‚úÖ
# Art Workshop in the Park ‚Üí ['art_exhibits', 'parks', 'workshops'] ‚úÖ
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –í –∫–æ–¥–µ

```python
from core.query.facets import map_event_to_flags

event = {
    "title": "Modern Art Exhibition",
    "description": "Contemporary art gallery",
    "tags": ["art", "culture"]
}

flags = map_event_to_flags(event)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ['art_exhibits']
```

### 2. –í –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ

```bash
export DB_URL="sqlite:///data/wp.db"
export REDIS_URL="redis://default:<PASS>@<HOST>:<PORT>"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è —Ñ–ª–∞–≥–∞–º–∏
python3 scripts/diag_verify.py --date 2025-01-27 --days 7 --flags "art_exhibits,electronic_music,jazz_blues,rooftop,food_dining,workshops,cinema,markets,yoga_wellness,parks"
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**
- –°–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Ñ–ª–∞–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è

### 2. **–ì–∏–±–∫–æ—Å—Ç—å**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞

### 3. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**
- Fallback –º–µ—Ö–∞–Ω–∏–∑–º –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞–ø–ø–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π

### 4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- –ü—Ä–∞–≤–∏–ª–∞ –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç–∏ (–≥–æ—Ç–æ–≤–æ –¥–ª—è EN/TH)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–ª–æ–∏ –º–∞–ø–ø–∏–Ω–≥–∞

1. **–û—Å–Ω–æ–≤–Ω–æ–π –º–∞–ø–ø–µ—Ä** (`map_event_to_flags`)
   - –ê–Ω–∞–ª–∏–∑ title + description + tags
   - –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –º–∞—Ç—á–∏–Ω–≥–∞
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ñ–ª–∞–≥–æ–≤

2. **Fallback –º–∞–ø–ø–µ—Ä** (–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ)
   - –£–ø—Ä–æ—â—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
   - –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ `core/query/__init__.py`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏

- **`by_flag`**: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø–æ —Ñ–ª–∞–≥–∞–º
- **`unflagged_events`**: —Å–æ–±—ã—Ç–∏—è –±–µ–∑ —Ñ–ª–∞–≥–æ–≤ (–ø—Ä–æ–±–ª–µ–º–∞!)
- **`discrepancies`**: —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ë–î ‚Üî Redis

### –ü—Ä–∏–º–µ—Ä –æ—Ç—á—ë—Ç–∞

```json
{
  "db": {
    "events_total": 2,
    "by_flag": {"art_exhibits": 1},
    "unflagged_events": 0
  },
  "discrepancies": [
    {
      "day": "2025-01-27",
      "flag": "art_exhibits", 
      "problem": "DB has events for day/flag, Redis key empty or missing"
    }
  ]
}
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª**
- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
- –ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ø–ø–∏–Ω–≥–∞
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –º–∞–ø–ø–∏–Ω–≥–∞
- –ê–ª–µ—Ä—Ç—ã –Ω–∞ –ø—É—Å—Ç—ã–µ —Ñ–ª–∞–≥–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞–ø–ø–µ—Ä —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä—ë–Ω**

- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
- **–ö–∞—á–µ—Å—Ç–≤–æ**: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π  
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –±—ã—Å—Ç—Ä—ã–π –º–∞–ø–ø–∏–Ω–≥, fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É –º–∞–ø–ø–∏–Ω–≥—É —Å–æ–±—ã—Ç–∏–π!** üöÄ‚ú®
