# App Factory Pattern –¥–ª—è Week Planner API

## üéØ –ó–∞—á–µ–º –Ω—É–∂–µ–Ω App Factory

App Factory –ø–∞—Ç—Ç–µ—Ä–Ω —Ä–µ—à–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:

1. **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã** - –∏–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º —Å `main.py` –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—â–∏–º –º–æ–¥—É–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –µ–≥–æ
2. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** - –∏–∑–æ–ª–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–£—Å–ª–æ–≤–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–æ–≤** - –ª–µ–≥–∫–æ –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ñ–∏—á–µ—Ñ–ª–∞–≥–∏
4. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
apps/api/
‚îú‚îÄ‚îÄ app_factory.py      # üÜï –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
‚îú‚îÄ‚îÄ main.py            # ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ–∞–π–ª (—Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏)
‚îî‚îÄ‚îÄ routes/            # üìÅ –†–æ—É—Ç—ã (–±—É–¥—É—â–µ–µ)
    ‚îî‚îÄ‚îÄ places.py      # üè™ Places API —Ä–æ—É—Ç—ã

packages/wp_places/
‚îú‚îÄ‚îÄ api.py             # üÜï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è places —Ä–æ—É—Ç–æ–≤
‚îú‚îÄ‚îÄ service.py         # üîß –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ ...
```

### App Factory (`apps/api/app_factory.py`)

```python
def create_app() -> FastAPI:
    app = FastAPI()
    
    # –í—Å–µ–≥–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º places —Ä–æ—É—Ç—ã
    register_places_routes(app)
    
    # –£—Å–ª–æ–≤–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º event —Ä–æ—É—Ç—ã
    if not events_disabled():
        # register_event_routes(app)  # TODO: –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ
        pass
    else:
        # –î–æ–±–∞–≤–ª—è–µ–º stub —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
        add_event_stub_endpoints(app)
    
    return app
```

### Places API (`packages/wp_places/api.py`)

```python
def register_places_routes(app: FastAPI) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ places —Ä–æ—É—Ç—ã"""
    
    @app.get("/api/places")
    def api_places(city: str = "bangkok", flags: str = "", limit: int = 50):
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç
        
    @app.get("/api/places/categories")
    def api_places_categories():
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        
    # ... –¥—Ä—É–≥–∏–µ —Ä–æ—É—Ç—ã
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ App Factory (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è Makefile
make run-factory

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
uvicorn apps.api.app_factory:create_app --factory --reload
```

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π main.py (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
make run

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
uvicorn apps.api.main:app --reload
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –§–∏—á–µ—Ñ–ª–∞–≥ `WP_DISABLE_EVENTS`

```bash
# –û—Ç–∫–ª—é—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è (—Ç–æ–ª—å–∫–æ places)
export WP_DISABLE_EVENTS=1
make run-factory

# –í–∫–ª—é—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è (places + events)
export WP_DISABLE_EVENTS=0
make run-factory
```

### –†–æ—É—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∏—á–µ—Ñ–ª–∞–≥–∞

#### –ü—Ä–∏ `WP_DISABLE_EVENTS=1` (—Ç–æ–ª—å–∫–æ places):
- ‚úÖ `/api/places` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Å—Ç
- ‚úÖ `/api/places/categories` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- ‚úÖ `/api/places/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ `/api/places/warm-cache` - –ø—Ä–æ–≥—Ä–µ–≤ –∫–µ—à–∞
- ‚ùå `/api/events` ‚Üí 503 "Events temporarily disabled"
- ‚ùå `/api/plan` ‚Üí 503 "Planner (events) disabled"
- ‚ùå `/api/live-events` ‚Üí 503 "Live events temporarily disabled"
- ‚ùå `/api/plan-cards` ‚Üí 503 "Plan cards (events) disabled"
- ‚ùå `/api/day-cards` ‚Üí 503 "Day cards (events) disabled"
- ‚ùå `/api/categories` ‚Üí 503 "Event categories temporarily disabled"
- ‚ùå `/api/sources` ‚Üí 503 "Event sources temporarily disabled"
- ‚ùå `/api/debug/source-ping` ‚Üí 503 "Source ping (events) disabled"

#### –ü—Ä–∏ `WP_DISABLE_EVENTS=0` (places + events):
- ‚úÖ `/api/places` - –≤—Å–µ places —Ä–æ—É—Ç—ã
- ‚úÖ `/api/events` - —Å–æ–±—ã—Ç–∏—è (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ)
- ‚úÖ `/api/plan` - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ)
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ event —Ä–æ—É—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ App Factory

```bash
# –¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç–∞
python3 -c "from apps.api.app_factory import create_app; print('‚úÖ Import OK')"

# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
python3 -c "from apps.api.app_factory import create_app; app = create_app(); print(f'Routes: {len(app.routes)}')"

# –¢–µ—Å—Ç —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
WP_DISABLE_EVENTS=1 python3 -c "from apps.api.app_factory import create_app; app = create_app(); print('‚úÖ Events disabled OK')"

# –¢–µ—Å—Ç —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
WP_DISABLE_EVENTS=0 python3 -c "from apps.api.app_factory import create_app; app = create_app(); print('‚úÖ Events enabled OK')"
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Places

```bash
# –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∞—Ä–≥–µ—Ç –¥–ª—è CI
make ci-places

# –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
make test-places
make test-redis
make smoke-places
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω

1. ‚úÖ **–°–æ–∑–¥–∞–Ω App Factory** - `apps/api/app_factory.py`
2. ‚úÖ **–°–æ–∑–¥–∞–Ω Places API** - `packages/wp_places/api.py`
3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω Makefile —Ç–∞—Ä–≥–µ—Ç** - `make run-factory`
4. üîÑ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
5. üìù **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - —ç—Ç–æ—Ç README
6. üöÄ **–ü—Ä–æ–¥–∞–∫—à–Ω** - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ app factory
7. üßπ **–û—á–∏—Å—Ç–∫–∞** - —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ main.py

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ App Factory —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Places —Ä–æ—É—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –§–∏—á–µ—Ñ–ª–∞–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Stub —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Å–æ–±—ã—Ç–∏–π
- ‚ö†Ô∏è –°—Ç–∞—Ä—ã–π main.py —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ App Factory

1. **–ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ–±–ª–µ–º** - —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ main.py –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ app factory
2. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
5. **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make run`** - –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make run-factory`** - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞
3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ñ–∏—á–µ—Ñ–ª–∞–≥** - `WP_DISABLE_EVENTS` –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make ci-places`

## üîÆ –ë—É–¥—É—â–µ–µ

1. **Event API –º–æ–¥—É–ª—å** - —Å–æ–∑–¥–∞–Ω–∏–µ `packages/wp_events/api.py`
2. **–†–æ—É—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö** - `apps/api/routes/places.py`, `apps/api/routes/events.py`
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** - –±–æ–ª–µ–µ –≥–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
4. **Middleware –∏ –ø–ª–∞–≥–∏–Ω—ã** - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ observability

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make run-factory` –≤–º–µ—Å—Ç–æ `make run`
